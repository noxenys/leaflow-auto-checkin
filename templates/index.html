<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflow è‡ªåŠ¨ç­¾åˆ°ç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .log-box { background: #212529; color: #00ff00; padding: 15px; border-radius: 5px; height: 400px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <h2 class="mb-4 text-center">ğŸƒ Leaflow è‡ªåŠ¨ç­¾åˆ°ç®¡ç†é¢æ¿</h2>

        <div class="row">
            <!-- è´¦å·é…ç½® -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <span>ğŸ“‹ è´¦å·ç®¡ç†</span>
                        <button class="btn btn-sm btn-light" @click="addAccount">æ·»åŠ è´¦å·</button>
                    </div>
                    <div class="card-body">
                        <div v-for="(acc, index) in config.accounts" :key="index" class="input-group mb-2">
                            <input type="text" class="form-control" placeholder="é‚®ç®±" v-model="acc.email">
                            <input type="text" class="form-control" placeholder="å¯†ç " v-model="acc.password">
                            <button class="btn btn-danger" @click="removeAccount(index)">åˆ é™¤</button>
                        </div>
                        <div v-if="config.accounts.length === 0" class="text-muted text-center">æš‚æ— è´¦å·ï¼Œè¯·æ·»åŠ </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <span>ğŸª Cookie ç®¡ç† (å…å¯†ç™»å½•)</span>
                        <button class="btn btn-sm btn-light" @click="addCookie">æ·»åŠ  Cookie</button>
                    </div>
                    <div class="card-body">
                        <div v-for="(cookie, index) in config.cookies" :key="index" class="mb-2">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="ç²˜è´´å®Œæ•´ Cookie å­—ç¬¦ä¸²" v-model="cookie.value">
                                <button class="btn btn-danger" @click="removeCookie(index)">åˆ é™¤</button>
                            </div>
                            <small class="text-muted">æ¨èä½¿ç”¨ Cookieï¼Œå¯è·³è¿‡ç™»å½•éªŒè¯ç ã€‚</small>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-info text-white">ğŸ“¢ Telegram é€šçŸ¥</div>
                    <div class="card-body">
                        <div class="mb-2">
                            <label>Bot Token</label>
                            <input type="text" class="form-control" v-model="config.telegram.token">
                        </div>
                        <div class="mb-2">
                            <label>Chat ID</label>
                            <input type="text" class="form-control" v-model="config.telegram.chat_id">
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary w-100 mb-3" @click="saveConfig" :disabled="saving">
                    {{ saving ? 'ä¿å­˜ä¸­...' : 'ğŸ’¾ ä¿å­˜é…ç½®' }}
                </button>
                <button class="btn btn-warning w-100 mb-3" @click="runCheckin" :disabled="running">
                    {{ running ? 'è¿è¡Œä¸­...' : 'ğŸš€ ç«‹å³è¿è¡Œç­¾åˆ°' }}
                </button>
            </div>

            <!-- æ—¥å¿—æ˜¾ç¤º -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <span>ğŸ“œ è¿è¡Œæ—¥å¿—</span>
                        <button class="btn btn-sm btn-outline-light" @click="fetchLogs">åˆ·æ–°</button>
                    </div>
                    <div class="card-body p-0">
                        <div class="log-box" ref="logBox">{{ logs }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    config: {
                        accounts: [],
                        cookies: [],
                        telegram: { token: '', chat_id: '' }
                    },
                    logs: 'åŠ è½½æ—¥å¿—ä¸­...',
                    saving: false,
                    running: false
                }
            },
            mounted() {
                this.fetchConfig();
                this.fetchLogs();
                setInterval(this.fetchLogs, 5000); // è‡ªåŠ¨åˆ·æ–°æ—¥å¿—
            },
            methods: {
                async fetchConfig() {
                    try {
                        const res = await axios.get('/api/config');
                        this.config = res.data;
                        if (!this.config.accounts) this.config.accounts = [];
                        if (!this.config.cookies) this.config.cookies = [];
                        if (!this.config.telegram) this.config.telegram = {};
                    } catch (e) {
                        console.error(e);
                    }
                },
                async saveConfig() {
                    this.saving = true;
                    try {
                        await axios.post('/api/config', this.config);
                        alert('é…ç½®å·²ä¿å­˜');
                    } catch (e) {
                        alert('ä¿å­˜å¤±è´¥');
                    } finally {
                        this.saving = false;
                    }
                },
                addAccount() {
                    this.config.accounts.push({ email: '', password: '' });
                },
                removeAccount(index) {
                    this.config.accounts.splice(index, 1);
                },
                addCookie() {
                    // é™åˆ¶åªèƒ½æ·»åŠ ä¸€ä¸ª Cookieï¼Œå› ä¸ºè„šæœ¬é€»è¾‘ç›®å‰åªæ”¯æŒä¸€ä¸ª
                    if (this.config.cookies.length > 0) {
                        alert('ç›®å‰ä»…æ”¯æŒé…ç½®ä¸€ä¸ª Cookie');
                        return;
                    }
                    this.config.cookies.push({ value: '' });
                },
                removeCookie(index) {
                    this.config.cookies.splice(index, 1);
                },
                async runCheckin() {
                    this.running = true;
                    try {
                        await axios.post('/api/run');
                        alert('ä»»åŠ¡å·²å¯åŠ¨ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—');
                    } catch (e) {
                        alert('å¯åŠ¨å¤±è´¥');
                    } finally {
                        setTimeout(() => this.running = false, 3000);
                    }
                },
                async fetchLogs() {
                    try {
                        const res = await axios.get('/api/logs');
                        this.logs = res.data.logs;
                        // Auto scroll to bottom
                        this.$nextTick(() => {
                            const box = this.$refs.logBox;
                            if (box) box.scrollTop = box.scrollHeight;
                        });
                    } catch (e) {
                        console.error(e);
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
